<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Control Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
    </style>
</head>
<body>
    <header class="container">
        <h1>Farm Control Dashboard</h1>
    </header>
    <main class="container">
        <section class="container mt-3">
            <div class="d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="fs-3 fw-bold me-3"> camera websocket server state : </span> <div id="camera-ws-state"></div>
                </div>
                <button class="btn btn-primary" id="camera-ws-btn">start</button>
            </div>
            <!-- <div id -->
        </section>
        <section class="container mt-3">
            <div class="d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="fs-3 fw-bold me-3"> camera http server state : </span> <div id="camera-http-state"></div>
                </div>
                <button class="btn btn-primary" id="camera-http-btn"> camera http server start</button>
            </div>
            <!-- <div id -->
        </section>
        <section class="container mt-3">
            <div class="d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="fs-3 fw-bold me-3">sensor/control ws server state : </span> <div id="sensor-ws-state"></div>
                </div>
                <button class="btn btn-primary" id="control-ws-btn"> sensor/control ws server start</button>
            </div>
            <!-- <div id -->
        </section>
    </main>
    <script>
        const checkWSState = (ws, stateTag) => {
            switch (ws.readyState) {
                case WebSocket.CONNECTING:
                    const connectionTimeout = setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            stateTag.innerHTML = '<span class="badge text-bg-danger">Error!</span>'
                            ws.close();
                        }
                    }, 5000);
                    stateTag.innerHTML = '<span class="badge text-bg-warning">connecting...</span>'
                    break;
                case WebSocket.OPEN:
                    stateTag.innerHTML = '<span class="badge text-bg-success">running!</span>'
                    break;
                case WebSocket.CLOSING:
                    stateTag.innerHTML = '<span class="badge text-bg-danger">Error!</span>'
                    break;
                case WebSocket.CLOSED:
                    stateTag.innerHTML = '<span class="badge text-bg-danger">Error!</span>'
                    break;
                default:
                    console.log("Default.");
                    break;
            }
        };
    </script>
    <script>
        const checkHttpState = (stateTag) => {
            const url = 'http://localhost:8081/stream';

            fetch(url)
                .then(response => {
                    if (response.ok) {
                        stateTag.innerHTML = '<span class="badge text-bg-success">running!</span>'
                    } else {
                        stateTag.innerHTML = '<span class="badge text-bg-danger">Error!</span>'
                    }
                })
                .catch(error => {
                    stateTag.innerHTML = '<span class="badge text-bg-danger">Error!</span>'
                });
        }
    </script>
    <script>
        const cameraWs = new WebSocket('ws://localhost:3000');
        const sensorControlWs = new WebSocket('ws://localhost:3001');
        const cameraState = document.getElementById("camera-ws-state");
        const cameraHttpState = document.getElementById("camera-http-state")
        const sensorState = document.getElementById("sensor-ws-state");
        const checkCameraWebSocketState = setInterval(() => {checkWSState(cameraWs, cameraState);}, 1000);
        const checkCameraHttpState = setInterval(() => {checkHttpState(cameraHttpState);}, 1000)
        const checkSensorControlWebSocketState = setInterval(() => {checkWSState(sensorControlWs, sensorState);}, 1000);
    </script>
    <script>
        const bridge = new WebOSServiceBridge();

        const startServer = (url) => {
            console.log("start server function");
            // const url = 'luna://com.farm.server.dashboard.service/startWSServer';
            const params = {};
            bridge.onservicecallback = (msg) => {
                console.log(msg);
                let res = JSON.parse(msg);
                // document.getElementById("txt_msg").innerHTML = res.reply;
                const checkWebSocketState = setInterval(checkWSState, 1000);
            };
            bridge.call(url, JSON.stringify(params));
        }
        document.querySelector("#camera-ws-btn").addEventListener("click", () => {startServer('luna://com.farm.server.camera.service/startWSServer');});
        document.querySelector("#camera-http-btn").addEventListener("click", () => {startServer('luna://com.farm.server.camera.service/startHttpServer')});
        document.querySelector("#control-ws-btn").addEventListener("click", () => {startServer('luna://com.farm.server.socket.server.service/sensorControlServer')});
    </script>
</body>
</html>
